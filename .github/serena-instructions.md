# Serena MCP Instructions（`bitcoin-bot-gmo`）

このファイルは、Copilot Chat / AIエージェントが **全作業で Serena MCP を必須利用**するための実行ルールです。

## Serena MCPルール
- 解答には可能な限り Serena MCP を使用すること（本プロジェクトでは実質必須）。

## 0) Serena MCP — 読み取りとオンボーディングは必須
- 既存コードの理解や参照が必要な場合、**必ず Serena MCP を経由**して読み取る。
   - 例: シンボル探索、参照探索、パターン検索、メモリ参照、ファイル読取
- プロジェクト分析（オンボーディング）が未実行の場合は、最初の提案前に必ず実行する。
- オンボーディングでは、構成・依存関係・規約を読み込み、その知識を基盤に提案する。
- プロジェクト構成や依存が大きく変化した場合は、再オンボーディングしてから提案する。

## 1. 最優先原則
- 既存コードの理解が必要なときは、**必ず Serena MCP** を使って探索・参照する。
- 実装変更時は、対象コードと隣接テストを Serena 経由で確認してから編集する。
- 特に大きいファイルは全体readを避け、まずシンボル単位で必要範囲を特定する。
- 「読んでから書く」を徹底し、推測ベースの横展開を避ける。

## 1) まず文脈を読む
1. Serena でまずリポジトリ構成と規約を確認する
   - コーディング規約/フォーマッタ設定（例: `.editorconfig`, `.pre-commit-config.yaml`）
   - ビルド/テスト設定（例: `pyproject.toml`, `.github/workflows/ci.yml`）
   - フレームワーク/環境設定（例: `configs/*.yaml`, `docker-compose.yml`, `Dockerfile`）
2. 変更対象ファイルと関連する依存モジュール・型・テストを特定する
3. **書く前に必ず読む**: 対象ファイルと隣接する型定義やテストを Serena で開く

## 2. セッション開始時（オンボーディング）
- まず Serena プロジェクトを有効化し、オンボーディング状態を確認する。
- オンボーディング未実施なら、最初の提案前に実施する。
- リポジトリ構造や主要契約が大きく変わったと判断した場合は再オンボーディングする。
- オンボーディング確認なしでコード提案・編集を開始しない。

## 3. 推奨ツール利用順
1. プロジェクト状態確認: `mcp_oraios_serena_get_current_config`
2. 対象の探索: シンボル検索/参照検索/パターン検索（Serena系）
3. 必要箇所のみ読取: シンボル単位で本文取得
4. 変更適用: 小さく局所的に編集
5. 影響確認: 参照箇所・関連テストを更新

## 4. このプロジェクトでの必須チェックポイント
- `main.run` の固定フローを壊さない:
  - `load_runtime_config` -> `validate_config` -> mode runner -> `emit_run_complete`
- run完了契約を壊さない:
  - `var/artifacts/run_complete.json` の atomic write
  - `BEGIN_RUN_COMPLETE_JSON` / `END_RUN_COMPLETE_JSON`
- Discord通知は非致命を維持（失敗でプロセスを落とさない）。

## 5. 変更提案フォーマット（Serena前提）
1. コンテキスト
   - Serenaで参照したファイル/シンボル（最大6件）
   - 主要発見（最大6点）
2. 差分
   - 最小変更の unified diff
3. 理由
   - 根拠・代替案・トレードオフ（3〜5点）
4. 検証
   - このリポジトリの実コマンド（`pytest -q`, `pre-commit run --all-files` など）

## 6. Serena利用不可時の扱い
- Serenaが使えない場合は、その旨を明示してから続行する。
- ユーザーへ次を確認する:
  - 「Serena経由の読取が無効です。有効化しますか？ それとも最小仮説で続行しますか？」
- 最小仮説で続行する場合でも、推測での広範囲変更は避ける。

## 7. 禁止事項
- Serena未使用のまま、既存コード理解を前提に断定的な提案をしない。
- プロジェクト規約は自動検出し遵守する。
- 無関係な巻き込み変更・大規模リネーム・不要な整形をしない。
- 機密情報（APIキー等）を生成・出力しない。
